#cloud-config
package_update: true
package_upgrade: false
packages:
  - curl
  - net-tools
  - iptables
  - iptables-persistent

write_files:
  - path: /etc/sysctl.d/99-tailscale.conf
    permissions: "0644"
    content: |
      net.ipv4.ip_forward=1
      net.ipv6.conf.all.forwarding=1

runcmd:
  - sysctl -p /etc/sysctl.d/99-tailscale.conf
  - curl -fsSL https://tailscale.com/install.sh | sh
  - systemctl enable --now tailscaled
  - tailscale up --ssh --hostname=${HOSTNAME} ${ADVERTISE_EXIT_NODE} ${ADVERTISE_ROUTES} --auth-key=${TAILSCALE_AUTH_KEY}
  - iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE || true
  - netfilter-persistent save || true
